<!DOCTYPE html>
<html lang="hr">
<head>
    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#e67e22">
<link rel="icon" type="image/png" href="icon-192.png">
<link rel="apple-touch-icon" href="icon-192.png">
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monikina Kuhinja</title>
    
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; margin: 0; padding: 10px; display: flex; justify-content: center; }
        .app-card { background: white; padding: 15px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        header { text-align: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        h1 { margin: 5px 0; color: #2c3e50; font-size: 20px; }

        .food-item { background: #fff; border: 1px solid #eee; border-left: 6px solid #e67e22; padding: 12px; border-radius: 15px; margin-bottom: 12px; position: relative; transition: 0.3s; }
        .active-cooking { border-left-color: #3498db; background: #f7fbff; }
        
        .delete-btn { position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 18px; color: #ddd; cursor: pointer; }
        .food-header { font-weight: bold; font-size: 18px; margin-bottom: 10px; color: #2c3e50; }

        .calc-row { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; background: #f8f9fa; padding: 10px; border-radius: 10px; }
        input[type="number"] { width: 70px; padding: 8px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        .ml-result { color: #2980b9; font-weight: 800; font-size: 16px; }

        /* PROGRESS BAR STIL */
        .progress-container { width: 100%; height: 8px; background: #eee; border-radius: 4px; margin: 10px 0; overflow: hidden; display: none; }
        .progress-bar { height: 100%; background: #e67e22; width: 0%; transition: width 0.5s linear; }
        .active-cooking .progress-container { display: block; }

        .timer-row { display: flex; justify-content: space-between; align-items: center; }
        .time-display { font-size: 24px; font-weight: bold; font-family: monospace; color: #2c3e50; }
        button { cursor: pointer; border: none; border-radius: 10px; font-weight: bold; transition: 0.2s; }
        .btn-cook { background: #3498db; color: white; padding: 10px 18px; }
        .btn-stop { background: #e74c3c; color: white; padding: 10px 18px; }

        .add-section { margin-top: 20px; padding: 15px; border-radius: 15px; background: #fafafa; border: 1px dashed #ccc; }
        .add-section input { width: 100%; margin-bottom: 8px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
        .btn-add { width: 100%; padding: 12px; background: #27ae60; color: white; }
        
        #history-list { max-height: 150px; overflow-y: auto; font-size: 13px; margin-top: 10px; background: #f9f9f9; padding: 5px; border-radius: 8px; }
        .history-item { padding: 6px; border-bottom: 1px solid #eee; color: #555; }
        
        @keyframes blink { 50% { opacity: 0.3; } }
        .finished { color: #e74c3c !important; animation: blink 0.8s infinite; }
    </style>
</head>
<body>

<div class="app-card">
    <header><h1>üç≥ Monikina Kuhinja</h1></header>
    
    <div id="food-list"></div>

    <div class="add-section">
        <h4 style="margin:0 0 10px 0">‚ûï Dodaj namirnicu</h4>
        <input type="text" id="newName" placeholder="Naziv">
        <input type="number" id="newTime" placeholder="Minuta">
        <input type="number" id="newWater" placeholder="ml vode">
        <input type="number" id="newGrams" placeholder="grama">
        <button class="btn-add" onclick="addNewFood()">SPREMI</button>
    </div>
    
    <div style="margin-top:20px; border-top: 2px solid #eee; padding-top:10px;">
        <h4 style="margin:0">üìú Povijest kuhanja</h4>
        <div id="history-list"></div>
        <button onclick="clearHistory()" style="margin-top:8px; background:none; color:#e74c3c; font-size:11px; border:1px solid #e74c3c; width:100%; padding:5px;">Obri≈°i povijest</button>
    </div>
</div>

<script>
    // Tra≈æenje dozvole za obavijesti ƒçim se aplikacija uƒçita
function requestNotificationPermission() {
    if ('Notification' in window) {
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                console.log('Obavijesti dozvoljene!');
            }
        });
    }
}
requestNotificationPermission();

// Funkcija koja ≈°alje poruku Service Workeru da prika≈æe obavijest
function sendNotification(title, message) {
    if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({
            type: 'SHOW_NOTIFICATION',
            title: title,
            body: message
        });
    }
}
    
    let history = JSON.parse(localStorage.getItem('monika_history')) || [];
    const defaultFoods = [
        { name: "Ri≈æa", time: 25, water: 280, grams: 35 },
        { name: "Griz", time: 4, water: 300, grams: 40 },
        { name: "Palenta", time: 10, water: 300, grams: 40 }
    ];
    let foods = JSON.parse(localStorage.getItem('monika_foods')) || defaultFoods;
    let activeTimers = {};
    let audioCtx = null;

    function render() {
        const list = document.getElementById('food-list');
        list.innerHTML = '';
        foods.forEach((f, i) => {
            const startMl = f.name.includes("Ri≈æa") ? Math.round((f.grams * 2.5) + 192) : f.water;
            const isActive = activeTimers[i] ? 'active-cooking' : '';
            
            list.innerHTML += `
                <div class="food-item ${isActive}" id="card-${i}">
                    <button class="delete-btn" onclick="deleteFood(${i})">üóëÔ∏è</button>
                    <div class="food-header">${f.name}</div>
                    <div class="calc-row">
                        <input type="number" id="in-${i}" value="${f.grams}" oninput="updateWater(${i}, this.value)">
                        <span>g ‚û°Ô∏è</span>
                        <span class="ml-result" id="res-${i}">${startMl} ml</span>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar" id="prog-${i}"></div>
                    </div>
                    <div class="timer-row">
                        <div class="time-display" id="disp-${i}">${activeTimers[i] ? '...' : f.time + ':00'}</div>
                        <button class="${activeTimers[i] ? 'btn-stop' : 'btn-cook'}" id="btn-${i}" onclick="toggleTimer(${i})">
                            ${activeTimers[i] ? 'STOP' : 'KUHAJ'}
                        </button>
                    </div>
                </div>`;
        });
    }

    function updateWater(i, val) {
        const f = foods[i];
        const g = parseFloat(val) || 0;
        let res = f.name.includes("Ri≈æa") 
            ? (g > 0 ? Math.round((g * 2.5) + 192) : 0)
            : (g > 0 ? Math.round((g / f.grams) * f.water) : 0);
        document.getElementById(`res-${i}`).innerText = res + " ml";
    }

    function toggleTimer(i) {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        if (activeTimers[i]) {
            clearInterval(activeTimers[i].interval);
            if(activeTimers[i].osc) try { activeTimers[i].osc.stop(); } catch(e) {}
            delete activeTimers[i];
            render();
        } else {
            const durationMs = foods[i].time * 60 * 1000;
            const startTime = Date.now();
            const endTime = startTime + durationMs;
            
            document.getElementById(`btn-${i}`).innerText = "STOP";
            document.getElementById(`btn-${i}`).className = "btn-stop";
            document.getElementById(`card-${i}`).classList.add('active-cooking');

            activeTimers[i] = {
                startTime: startTime,
                endTime: endTime,
                durationMs: durationMs,
                interval: setInterval(() => updateUI(i), 500),
                isFinished: false
            };
        }
    }

    function updateUI(i) {
        const timer = activeTimers[i];
        if (!timer) return;

        const now = Date.now();
        const remaining = Math.max(0, Math.floor((timer.endTime - now) / 1000));
        const elapsed = now - timer.startTime;
        
        // Izraƒçun postotka za progress bar
        const percent = Math.min(100, (elapsed / timer.durationMs) * 100);
        const bar = document.getElementById(`prog-${i}`);
        if(bar) bar.style.width = percent + "%";
        
        const display = document.getElementById(`disp-${i}`);
        if (remaining <= 0) {
            if (!timer.isFinished) {
                timer.isFinished = true;
                display.innerText = "GOTOVO!";
                display.classList.add('finished');
                sendNotification("üç≥ Monikina Kuhinja", `${foods[i].name} je gotova!`);
                saveToHistory(foods[i].name, document.getElementById(`in-${i}`).value, document.getElementById(`res-${i}`).innerText);
                playAlarm(i);
            }
        } else {
            const m = Math.floor(remaining / 60);
            const s = remaining % 60;
            display.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
        }
    }

    function playAlarm(i) {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(880, audioCtx.currentTime);
        gain.gain.setValueAtTime(0, audioCtx.currentTime);
        for(let t=0; t<60; t+=0.5) {
            gain.gain.linearRampToValueAtTime(0.2, audioCtx.currentTime + t + 0.1);
            gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + t + 0.4);
        }
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start();
        activeTimers[i].osc = osc;
    }

    function saveToHistory(name, g, ml) {
        const now = new Date();
        const entry = `${now.getHours()}:${(now.getMinutes()<10?'0':'')+now.getMinutes()} - ${name}: ${g}g (${ml})`;
        history.unshift(entry);
        if(history.length > 10) history.pop();
        localStorage.setItem('monika_history', JSON.stringify(history));
        renderHistory();
    }

    function renderHistory() {
        document.getElementById('history-list').innerHTML = history.map(h => `<div class="history-item">${h}</div>`).join('');
    }

    function addNewFood() {
        const n = document.getElementById('newName').value, t = document.getElementById('newTime').value, w = document.getElementById('newWater').value, g = document.getElementById('newGrams').value;
        if(n && t && w && g) {
            foods.push({ name: n, time: parseInt(t), water: parseInt(w), grams: parseInt(g) });
            localStorage.setItem('monika_foods', JSON.stringify(foods));
            render();
            document.getElementById('newName').value = '';
        }
    }

    function deleteFood(i) {
        if(confirm("Obri≈°i?")) {
            if(activeTimers[i]) clearInterval(activeTimers[i].interval);
            foods.splice(i, 1);
            localStorage.setItem('monika_foods', JSON.stringify(foods));
            render();
        }
    }

    function clearHistory() { history = []; localStorage.removeItem('monika_history'); renderHistory(); }

    render();
    renderHistory();
    // Registracija Service Workera za offline rad
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js');
}
    // Slu≈°aj poruke iz Service Workera (za gumb iz obavijesti)
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.addEventListener('message', event => {
        if (event.data.type === 'STOP_ALL_AUDIO') {
            // Prolazimo kroz sve aktivne tajmere i gasimo njihove oscilatore
            Object.keys(activeTimers).forEach(i => {
                if (activeTimers[i] && activeTimers[i].osc) {
                    try { 
                        activeTimers[i].osc.stop(); 
                        delete activeTimers[i].osc;
                    } catch(e) {}
                    // Opcionalno: resetiraj tajmer vizualno
                    toggleTimer(i); 
                }
            });
        }
    });
}
    
</script>

</body>
</html>
